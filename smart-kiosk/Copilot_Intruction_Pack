Below is the **COMPLETE, READY-TO-PASTE COPILOT INSTRUCTION PACK**.
You can paste this directly into GitHub Copilot Chat or VSCode Copilot sidebar.

It contains:

âœ” The dependency map
âœ” The allowed vs NOT allowed changes
âœ” The rules Copilot must follow
âœ” The wiring that must be fixed â€” safely
âœ” The forbidden renames

**Copilot will fix ONLY the wiring, NOTHING else.**

---

# ğŸš€ **COPILOT INSTRUCTION PACK â€” Smart-Kiosk (STRICT RULES)**

### ğŸ“Œ *Paste everything below into Copilot:*

---

# ğŸ”µ **START OF INSTRUCTIONS FOR COPILOT (DO NOT MODIFY THIS TEXT)**

You are fixing a **Smart-Kiosk** Python project with the following directory structure:

```
Smart-Kiosk/
â”‚ main.py
â”‚ kiosk_app.py
â”‚ config.py
â”‚ pinmap.json
â”‚
â”œâ”€â”€ arduino/
â”‚     arduino_listener.py
â”‚
â”œâ”€â”€ hardware/
â”‚     gpio_manager.py
â”‚     acs712.py
â”‚     adc_mcp3008.py
â”‚
â”œâ”€â”€ db/
â”‚     firebase_helpers.py
â”‚     firebase_worker.py
â”‚
â”œâ”€â”€ services/
â”‚     session_manager.py
â”‚     billing_service.py
â”‚     charging_service.py
â”‚     water_service.py
â”‚
â”œâ”€â”€ ui/
â”‚   â”‚ ui_controller.py
â”‚   â””â”€â”€ screens/
â”‚         scan_screen.py
â”‚         register_choice_screen.py
â”‚         main_screen.py
â”‚         slot_select_screen.py
â”‚         charging_screen.py
â”‚         water_screen.py
â”‚         user_info.py
â”‚
â””â”€â”€ utils/
      events.py
```

Your job is to **fix the wiring and missing connections ONLY**, without renaming or redesigning anything.

---

# ğŸ”¥ **CRITICAL RULES (DO NOT BREAK ANY OF THESE)**

### âŒ **NEVER rename or remove any variable.**

These must stay exactly as they are:

```
active_uid
active_slot
charging_uid
charging_slot
remaining
cup_present
temp_water_time
users_ref
read_user
write_user
append_audit_log
record_coin_insert
get_slot
set_slot
set_active_user
clear_active_user
```

### âŒ **NEVER change UI layouts or appearance.**

Screens must stay visually identical.

### âŒ **NEVER rewrite logic inside screens.**

You may only connect them to controller methods.

### âŒ **NEVER rewrite hardware logic.**

### âŒ **NEVER touch firebase_helpers logic.**

---

# âœ… **WHAT YOU ARE ALLOWED TO FIX**

You may add missing controller functions **ONLY IF THEY ALREADY ARE CALLED BY SCREENS**, such as:

```
def set_active_user(self, uid): ...
def clear_active_user(self): ...
def get_slot(self, slot): ...
def set_slot(self, slot): ...
```

You may fix:

* Missing imports
* Wrong module paths
* Incorrect attribute access
* `KioskApp` missing methods
* frame registration issues
* Controllerâ€“Screen wiring
* Missing references to `read_user` or `write_user`

You may **NOT** change the method names.

---

# ğŸ§© **THE REQUIRED CONTROLLER METHODS (MUST EXIST)**

Screens already call these. If missing, ADD them **exactly** with these names:

```
set_active_user(uid)
clear_active_user()
get_user(uid) â†’ optional alias to read_user
get_slot(slot)
set_slot(slot)
refresh_all_user_info()
```

### `KioskApp` must expose:

* `read_user(uid)`
* `write_user(uid, data)`
* `append_audit_log(...)`
* `coin_counters`
* `active_uid`
* `active_slot`

And the methods listed above.

---

# ğŸ”— **WIRE MAP â€“ HOW COMPONENTS CONNECT (Copilot must enforce this)**

### ScanScreen â†’ KioskApp

* Uses: `read_user`, `write_user`, `create_nonmember`, `set_active_user`
* Navigates to:

  * `"MainScreen"` for existing users
  * `"RegisterChoiceScreen"` for new users

### RegisterChoiceScreen â†’ KioskApp

* Buttons call:

  * `start_register(uid)`
  * `continue_as_guest(uid)`
  * `start_subscription(uid)`
* MUST set:

  * `active_uid = uid`

### MainScreen â†’ KioskApp

Buttons:

* â€œWaterâ€ â†’ `show_frame("WaterScreen")`
* â€œChargingâ€ â†’ `show_frame("SlotSelectScreen")`
* â€œLogoutâ€ â†’ `clear_active_user()`

### SlotSelectScreen â†’ KioskApp

Uses:

* `active_uid`
* `controller.get_slot(slot_name)`
* `controller.active_slot`
* `record_coin_insert()`

After selecting a slot, screen calls:

```
controller.active_slot = slot_name
```

### ChargingScreen

Needs:

* `controller.active_uid`
* `controller.active_slot`
* `read_user`, `write_user`
* `append_audit_log`
* `hw.read_current(slot)`
* `hw.relay_on/off(slot)`
* `record_coin_insert()`

### WaterScreen

Needs:

* `controller.active_uid`
* `read_user`, `write_user`
* `arduino_listener` events
* `show_coin_popup`
* `show_totals_popup`

### UserInfoFrame

Must read:

* `controller.active_uid`
* `read_user(active_uid)`

---

# ğŸ”§ **TASKS YOU MUST PERFORM**

### âœ” 1. Fix missing controller functions

Implement these inside `KioskApp` **if missing**:

```
def set_active_user(self, uid)
def clear_active_user(self)
def get_slot(self, slot)
def set_slot(self, slot)
def get_user(self, uid)  # simple alias to read_user
def refresh_all_user_info(self)
```

### âœ” 2. Ensure all screens call these methods correctly

### âœ” 3. Ensure every screen is registered in KioskApp

Screens loaded must include:

```
ScanScreen
RegisterChoiceScreen
MainScreen
SlotSelectScreen
ChargingScreen
WaterScreen
UserInfoFrame
```

### âœ” 4. Ensure firebase_helpers is connected

All screens expect:

```
controller.read_user â†’ firebase_helpers.read_user
controller.write_user â†’ firebase_helpers.write_user
controller.users_ref  â†’ firebase RTDB reference
```

### âœ” 5. Do NOT change logic, names, UI design, or layout.

---

# ğŸŸ© **WHAT YOU MUST OUTPUT**

Produce:

1. **Exact modifications to kiosk_app.py**
2. **Any required small fixes in screens** but ONLY wiring
3. **Do NOT modify variable names**
4. **Do NOT change UI design**
5. **Do NOT rewrite logic**

---

# ğŸ”µ **END OF COPILOT INSTRUCTION PACK**

---
